<!DOCTYPE html>
<html class="no-js">
  <head>

    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>Using Emacs as a C++ IDE - Take 2</title>
<meta name="description" content="">
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- theme meta -->
<meta name="theme-name" content="airspace-jekyll" />

<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

<!-- CSS -->
<link rel="stylesheet" href="/css/owl.carousel.css" />
<link rel="stylesheet" href="/css/bootstrap.min.css" />
<link rel="stylesheet" href="/css/font-awesome.min.css" />
<link rel="stylesheet" href="/css/airspace.css" />
<link rel="stylesheet" href="/css/style.css" />
<link rel="stylesheet" href="/css/ionicons.min.css" />
<link rel="stylesheet" href="/css/animate.css" />
<link rel="stylesheet" href="/css/responsive.css" />
<link rel="stylesheet" href="/css/syntax.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css"  integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.0/css/academicons.min.css" integrity="sha512-W4yqoT1+8NLkinBLBZko+dFB2ZbHsYLDdr50VElllRcNt2Q4/GSs6u71UHKxB7S6JEMCp5Ve4xjh3eGQl/HRvg==" crossorigin="anonymous">

<!-- Js -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.10.2.min.js"><\/script>')</script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/owl.carousel.min.js"></script>
<script src="/js/plugins.js"></script>
<script src="/js/min/waypoints.min.js"></script>
<script src="/js/jquery.counterup.js"></script>
<script type="text/javascript"
src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">

<!-- scale size of the font -->
MathJax.Hub.Config({
"HTML-CSS": { scale: 90}
});

<!-- Some markdown fixes from http://cwoebker.com/posts/latex-math-magic -->
MathJax.Hub.Config({
      tex2jax: {
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre']
      }
});
MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for(i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });

</script>


<script src="/js/main.js"></script>

<!--
/*
 * Airspace
 * Ported to Jekyll by Andrew Lee
 * https://github.com/ndrewtl/airspace-jekyll
 * Designed and Developed by ThemeFisher
 * https://themefisher.com/
 *
 */
-->


  </head>
  <body>


    <!-- Header Start -->
<header>
<div class="container">
  <div class="row">
    <div class="col-md-12">
      <!-- header Nav Start -->
      <nav class="navbar navbar-default">
        <div class="container-fluid">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            </button>
            <!-- <a class="navbar-brand" href="index.html">
                 <img src="/img/logo.png" alt="Logo">
                 </a> -->

          <ul class="nav navbar-icons">
          <!-- Some hack to get the site title in the header -->
          <a href="/"><font size="6">Nils Deppe</font></a>&nbsp;&nbsp;&nbsp;&nbsp;
          
          <a href="/assets/pdfs/cv.pdf" target="_blank" title="CV"><i class="ai ai-cv ai-2x"></i></a>
          
          
          <a href="https://arxiv.org/search/?query=Deppe%2C+Nils&searchtype=author&abstracts=show&order=-announced_date_first&size=200" target="_blank" title="arXiv"><i class="ai ai-arxiv ai-2x"></i></a>
          
          
          <a href="https://github.com/nilsdeppe" target="_blank" title="GitHub"><i class="fab fa-github fa-2x"></i></a>
          
          <!-- 
               <a href="https://bitbucket.com/ndeppe" target="_blank" title="BitBucket"><i class="fab fa-bitbucket fa-2x"></i></a>
                -->
          
          <a href="https://www.linkedin.com/in/nilsdeppe" target="_blank" title="LinkedIn"><i class="fab fa-linkedin fa-2x"></i></a>
          
          </ul>
          </div>
          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
              <ul class="nav navbar-nav navbar-right">
                  <li><a href="/">Home</a></li>
                  <li><a href="/blog">Blog</a></li>
                  <!-- <li><a href="/work">Research</a></li> -->
              </ul>
          </div><!-- /.navbar-collapse -->
        </div><!-- /.container-fluid -->
      </nav>
    </div>
  </div>
</div>
</header><!-- header close -->



    <div class="post">
  <!-- Wrapper Start -->
  <section id="intro" style="border: 1px dotted #ddd;">
    <div class="container">
      <div class="row">
        <div>
          <div class="block">
            <h1>Using Emacs as a C++ IDE - Take 2</h1>
            <div class="post-info-wrapper">
              <p class="italic">By <span class="bold"></span> on <span class="bold">December 27, 2017</span></p>
            </div>
            <hr />
            <p><p><em>Updated Feb. 10, 2018</em><br />
<em>Updated Oct. 14, 2019</em><br />
Just over a year ago I wrote a
<a href="/posts/emacs-c++-ide">post</a> about using Emacs is a C++
IDE. Over the past year many small improvements have led me to an entirely
different configuration that I find to be much faster and easier to use.
In this post I will show screencasts of the features I’m using
and provide my entire init file at the end. There should be enough comments
in the init file to make it clear what’s going on. If not leave a comment
and I’ll try to explain.</p>

<p><strong>Note:</strong> <del>I use <code class="language-plaintext highlighter-rouge">emacs-nox</code>, i.e. a non-graphical Emacs. You may have
to perform some minor changes to get things to work in the graphical
Emacs.</del> <em>Edit:</em> I’ve started using <a href="https://github.com/millejoh/emacs-ipython-notebook">EIN</a> to be able to edit Jupyter
notebooks inside the GUI Emacs. While most of my work is still in the
terminal, I now have more confidence that this configuration works well
on both GUI and nox Emacs.</p>

<h3 id="overview-of-changes">Overview of Changes</h3>

<p>First I’ll just briefly outline what I changed and why.</p>

<ul>
  <li>Use Emacs server-client: faster startup when opening emacsclient than
when opening Emacs</li>
  <li>Better battery use: <a href="https://github.com/Andersbakken/rtags">RTags</a> is way too CPU intensive for what it
offers</li>
  <li>Better tags navigation: again, RTags uses too much CPU (really bad
for a laptop), and it also doesn’t scale well to really large projects
that have more than 100,000 lines of C++.</li>
  <li>cmake-ide is clumsy: that’s just it. It requires a lot of configuration
for each individual project, and depends too heavily on RTags</li>
  <li>Autocompletion using company-mode with semantic, irony, and rtags is
really slow, especially with large projects</li>
  <li><a href="https://github.com/abo-abo/swiper">Ivy</a> turns out to be a faster, more lightweight alternative to
<a href="https://github.com/emacs-helm/helm">Helm</a> that suites my needs just fine.</li>
</ul>

<p>The biggest reason that I continued investigating alternative configurations
is that RTags was just way too CPU intensive. It would use up all 8
hyperthreads if I let it, and every time I changed something in a low-level
header file it would re-parse the entire project. This was just way too
expensive on a laptop. It might be okay if you have a powerful desktop
and don’t care about battery life, but when you’re on the go it’s just
not a realistic implementation.</p>

<h3 id="faster-startup---the-emacs-server-and-client">Faster Startup - The Emacs Server and Client</h3>

<p>One thing that can be annoying as an Emacs configuration grows in
complexity is the increased startup time. There are a few ways of
dealing with this. One that looks promising but I have not tried
yet is [use-package][se-package]. The basic idea seems to be loading
packages lazily so that the total load time is spread out
rather than all at once.</p>

<p>I’ve opted for using the Emacs server-client approach. What this
means is I start Emacs once at login using systemd, then connect
to the running session using the emacsclient. The alias I use to
connect to Emacs is <code class="language-plaintext highlighter-rouge">alias ec="emacsclient -c"</code>. My systemd
file is in <code class="language-plaintext highlighter-rouge">~/.config/systemd/user/emacsd.service</code> and contains:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
</pre></td><td class="code"><pre><span class="o">[</span>Unit]
<span class="nv">Description</span><span class="o">=</span>Emacs: the extensible, self-documenting text editor
<span class="nv">Documentation</span><span class="o">=</span>man:emacs<span class="o">(</span>1<span class="o">)</span> info:Emacs

<span class="o">[</span>Service]
<span class="nv">Type</span><span class="o">=</span>forking
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/emacs <span class="nt">--daemon</span>
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/emacsclient <span class="nt">--eval</span> <span class="s2">"(progn (setq kill-emacs-hook nil) (kill-emacs))"</span>
<span class="nv">Restart</span><span class="o">=</span>on-failure
<span class="nv">Environment</span><span class="o">=</span><span class="nv">DISPLAY</span><span class="o">=</span>:%i
<span class="c"># Provide access to SSH</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">SSH_AUTH_SOCK</span><span class="o">=</span>/run/user/1000/keyring/ssh
<span class="c"># Setup modules</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">PATH</span><span class="o">=</span><span class="s2">"/home/nils/Research/mosh/install/bin/:/home/nils/Research/spack/opt/spack/linux-antergosrolling-x86_64/gcc-7.1.1/catch-1.9.4-qgdxfjhwk4mqhelhn2ggxmvyxvx6xm3k/bin:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/gsl-2.3-hsntrnj45jqjdmb6fq74tnxkmqxekts6/bin:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/openblas-0.2.19-if6giqoypphsmgle4anxox5kmb23g3vj/bin:/home/nils/Research/install/bin:/home/nils/.gem/ruby/2.4.0/bin:/usr/local/sbin:/usr/local/bin:/usr/bin:/usr/lib/jvm/default/bin:/usr/bin/site_perl:/usr/bin/vendor_perl:/usr/bin/core_perl:/home/nils/Research/spack/bin:/opt/intel/bin:/opt/intel/vtune_amplifier_xe_2017.2.0.499904/bin64:/home/nils/Research/llvm/build/bin:/home/nils/Research/templight-tools/build/bin:/home/nils/Research/standardese/build/tool:</span><span class="nv">$PATH</span><span class="s2">"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">CPATH</span><span class="o">=</span><span class="s2">"/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/brigand-master-pcaoburzhlfibhh4mvmcia2e6dkbry5x/include:/home/nils/Research/spack/opt/spack/linux-antergosrolling-x86_64/gcc-7.2.0/kvasir-mpl-develop-hr2lgqezjkiif3vbjsoxccorj2f5wppm/include:/home/nils/Research/spack/opt/spack/linux-antergosrolling-x86_64/gcc-7.1.1/catch-1.9.4-qgdxfjhwk4mqhelhn2ggxmvyxvx6xm3k/include:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/yaml-cpp-master-gmc3k4n2vsvmqwjcyqrxwaz2h5fukxc2/include:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/gsl-2.3-hsntrnj45jqjdmb6fq74tnxkmqxekts6/include:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/openblas-0.2.19-if6giqoypphsmgle4anxox5kmb23g3vj/include:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/libxsmm-1.8.1-mevsuzxzo47g33rihi4t7fdohp3ga7gk/include:/home/nils/Research/spack/opt/spack/linux-antergosrolling-x86_64/gcc-7.2.0/blaze-3.2-mnkglifq5s6ib5ltbvil4xt66fekqq2l/include:/home/nils/Research/install/include::/opt/petsc/linux-c-opt/include:</span><span class="nv">$CPATH</span><span class="s2">"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">LD_LIBRARY_PATH</span><span class="o">=</span><span class="s2">"/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/yaml-cpp-master-gmc3k4n2vsvmqwjcyqrxwaz2h5fukxc2/lib:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/gsl-2.3-hsntrnj45jqjdmb6fq74tnxkmqxekts6/lib:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/openblas-0.2.19-if6giqoypphsmgle4anxox5kmb23g3vj/lib:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/libxsmm-1.8.1-mevsuzxzo47g33rihi4t7fdohp3ga7gk/lib:/home/nils/Research/install/lib:::/opt/petsc/linux-c-opt/lib:</span><span class="nv">$LD_LIBRARY_PATH</span><span class="s2">"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">LIBRARY_PATH</span><span class="o">=</span><span class="s2">"/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/yaml-cpp-master-gmc3k4n2vsvmqwjcyqrxwaz2h5fukxc2/lib:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/gsl-2.3-hsntrnj45jqjdmb6fq74tnxkmqxekts6/lib:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/openblas-0.2.19-if6giqoypphsmgle4anxox5kmb23g3vj/lib:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/libxsmm-1.8.1-mevsuzxzo47g33rihi4t7fdohp3ga7gk/lib:/opt/petsc/linux-c-opt/lib:</span><span class="nv">$LIBRARY_PATH</span><span class="s2">"</span>
<span class="nv">Environment</span><span class="o">=</span><span class="nv">CMAKE_PREFIX_PATH</span><span class="o">=</span><span class="s2">"/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/brigand-master-pcaoburzhlfibhh4mvmcia2e6dkbry5x:/home/nils/Research/spack/opt/spack/linux-antergosrolling-x86_64/gcc-7.2.0/kvasir-mpl-develop-hr2lgqezjkiif3vbjsoxccorj2f5wppm:/home/nils/Research/spack/opt/spack/linux-antergosrolling-x86_64/gcc-7.1.1/catch-1.9.4-qgdxfjhwk4mqhelhn2ggxmvyxvx6xm3k:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/yaml-cpp-master-gmc3k4n2vsvmqwjcyqrxwaz2h5fukxc2:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/gsl-2.3-hsntrnj45jqjdmb6fq74tnxkmqxekts6:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/openblas-0.2.19-if6giqoypphsmgle4anxox5kmb23g3vj:/home/nils/Research/spack/opt/spack/linux-antergos17-x86_64/gcc-6.3.1/libxsmm-1.8.1-mevsuzxzo47g33rihi4t7fdohp3ga7gk:/home/nils/Research/spack/opt/spack/linux-antergosrolling-x86_64/gcc-7.2.0/blaze-3.2-mnkglifq5s6ib5ltbvil4xt66fekqq2l"</span>
<span class="nv">TimeoutStartSec</span><span class="o">=</span>0

<span class="o">[</span>Install]
<span class="nv">WantedBy</span><span class="o">=</span>default.target
</pre></td></tr></tbody></table></code></pre></figure>

<p>The important part is the <code class="language-plaintext highlighter-rouge">Environment=SSH_AUTH_SOCK</code> on line –
this ensures that you have access to your SSH agent from within
the Emacs session. Without this line
you will need to re-enter your SSH key’s password each time you use it.
Lines 14-18 add to various <code class="language-plaintext highlighter-rouge">PATH</code>s that I need for my work. Once you’ve
created the file run
<code class="language-plaintext highlighter-rouge">systemctl  --user enable emacsd.service &amp;&amp; systemctl --user start emacsd.service</code>
to start the backgrounded Emacs process and also set it to start at login.
The Emacs daemon can be restarted using
<code class="language-plaintext highlighter-rouge">systemctl --user restart emacsd.service</code>.</p>

<h3 id="ivy-and-swiper">Ivy and Swiper</h3>

<p>I’ve switched to using <a href="https://github.com/abo-abo/swiper">Ivy</a> for fuzzy matching instead of
<a href="https://github.com/emacs-helm/helm">Helm</a>. Ivy is quite a bit smaller than Helm because it only
serves as the underlying completion engine that other packages
plug in to. The important thing to note is that I also use <a href="https://github.com/BurntSushi/ripgrep">ripgrep</a>
for faster searching. If you do not or cannot install
ripgrep then just remove any lines referring to <code class="language-plaintext highlighter-rouge">ripgrep</code> or <code class="language-plaintext highlighter-rouge">rg</code> from my
init file. In the screencast below I show the use of Ivy’s fuzzy matching when
opening a file, as well as when using <code class="language-plaintext highlighter-rouge">project-find-file</code>. For ease-of-use
I’ve mapped <code class="language-plaintext highlighter-rouge">C-x M-f</code> to <code class="language-plaintext highlighter-rouge">project-find-file</code>. Because of this I haven’t
really found a strong reason to use <a href="https://github.com/bbatsov/projectile">projectile</a>.</p>

<p><br />
<img src="/assets/images/emacs_ide2_ivy.gif" alt="Ivy Example" align="middle" />
<br /></p>

<p>Another useful plugin that builds on top of Ivy is <a href="https://github.com/abo-abo/swiper">swiper</a>, which
replaces the standard search in Emacs. Rather than having to manually jump
through the file, swiper shows all the matches in an extended minibuffer. This
means that forward and reverse search are effectively the same and both
can be remapped to swiper.</p>

<p><br />
<img src="/assets/images/emacs_ide2_swiper.gif" alt="Swiper Example" align="middle" />
<br /></p>

<h3 id="navigating-the-code-base-with-tags">Navigating the Code Base With Tags</h3>

<p>Similar to RTags, there are <a href="https://github.com/universal-ctags/ctags">CTags</a>, and <a href="https://www.gnu.org/software/global/">GTags</a>. These allow
you to rapidly navigate the code base by jumping to the definition of a class
or function. For example, say I want to see the definition of a function
that’s used in the code I’m looking at. Well, I can jump to the definition
by pressing <code class="language-plaintext highlighter-rouge">M-.</code>. Once I’ve
understood what I needed to from the function definition I can jump back
to where I was previously by pressing <code class="language-plaintext highlighter-rouge">M-,</code>. Similarly, <code class="language-plaintext highlighter-rouge">M-t</code> shows all the
occurrences of the word-at-point in the tags database. Hopefully this makes
the use case for tags quite clear. What I wanted was a fast-parsing, and
accurate tag implementation. After trying around five different ones
I finally settled on <a href="https://github.com/universal-ctags/ctags">Universal-CTags</a> as the generator for the tags
database. The first step is installing <a href="https://github.com/universal-ctags/ctags">Universal-CTags</a> on your
system. You should verify you have Universal-CTags installed and not some
other implementation by running <code class="language-plaintext highlighter-rouge">ctags --version</code>.</p>

<p>For navigating the tags inside Emacs I use <a href="https://github.com/redguardtoo/counsel-etags">counsel-etags</a>,
which works really well despite being quite young. My configuration
triggers a rebuild of the tags database every time you save a file in the
project and 3 minutes have elapsed since the last time a rebuild was
triggered. This ensures
navigation to new classes and functions is possible. Note that
as of this writing I override the provided auto-update function with one
that is capable of using wildcards in both file names and directory names.
By default only file names support wild cards. Below is a demo of the
source code navigation.</p>

<p><br />
<img src="/assets/images/emacs_ide2_tags.gif" alt="CTags Example" align="middle" />
<br /></p>

<h3 id="pretty-code-with-clangformat">Pretty Code With ClangFormat</h3>

<p>If you aren’t using <a href="https://clang.llvm.org/docs/ClangFormat.html">ClangFormat</a> you should very seriously
consider it. Here’s my simple Emacs config for it:</p>

<figure class="highlight"><pre><code class="language-elisp" data-lang="elisp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="code"><pre><span class="c1">;; clang-format can be triggered using C-c C-f</span>
<span class="c1">;; Create clang-format file using google style</span>
<span class="c1">;; clang-format -style=google -dump-config &gt; .clang-format</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">'clang-format</span><span class="p">)</span>
<span class="p">(</span><span class="nv">global-set-key</span> <span class="p">(</span><span class="nv">kbd</span> <span class="s">"C-c C-f"</span><span class="p">)</span> <span class="ss">'clang-format-region</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="syntax-highlighting-for-c11-and-beyond">Syntax Highlighting for C++11 and Beyond</h3>

<p>The builtin syntax highlighting doesn’t do a very good job when it comes
to modern C++. Luckily there’s a remedy:
<a href="https://github.com/ludwigpacifici/modern-cpp-font-lock">modern-cpp-font-lock</a>. Configure using:</p>

<figure class="highlight"><pre><code class="language-elisp" data-lang="elisp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="p">(</span><span class="nb">require</span> <span class="ss">'modern-cpp-font-lock</span><span class="p">)</span>
<span class="p">(</span><span class="nv">modern-c++-font-lock-global-mode</span> <span class="no">t</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="youcompleteme---fast-code-completion-update141019-switching-to-lsp-modeclangd">YouCompleteMe - Fast Code Completion (UPDATE(14/10/19): Switching to lsp-mode+clangd)</h3>

<p>The two most important parts of code completion speed and accuracy.
If either of these is not outstanding then the code
completion will not be useful to a seasoned developer. A third criteria that
is important for me is that the code completion engine uses less CPU resources
than compiling the code would, otherwise I might as well just use the compiler
to give me suggestions. I also want to be able to use code completion when
I’m traveling and low CPU usage means better battery life. The best
solution that I’ve found is the <a href="https://github.com/Valloric/ycmd">YouCompleteMeDaemon</a> with
<a href="https://github.com/abingham/emacs-ycmd">emacs-ycmd</a>. ycmd uses libclang for finding completions and so
is accurate and fast, even with large projects. Additionally, it only
parses the file you currently have open, unlike some completion frameworks
that would re-parse the entire project.</p>

<p>First you must install the <a href="https://github.com/Valloric/ycmd">ycmd</a> server, for which instructions are
available <a href="https://github.com/Valloric/ycmd">here</a>. Next install the <a href="https://github.com/abingham/emacs-ycmd">emacs-ycmd</a>
package in Emacs, which hooks into <a href="https://github.com/company-mode/company-mode">company</a> and
<a href="http://www.flycheck.org/en/latest/">flycheck</a> to provide completions and on-the-fly syntax
checking. In the screencast below I show the use of the code completion and
syntax checking features together to output the size of a container to
standard out. The error message that appears at the end in the minibuffer
tells us that the <code class="language-plaintext highlighter-rouge">&lt;iostream&gt;</code> header was not included.</p>

<p><br />
<img src="/assets/images/emacs_ide2_ycmd.gif" alt="ycmd Example" align="middle" />
<br /></p>

<p>In my init file I have separated the setup of ycmd, company, and flycheck
into three different sections for easier maintenance in the future.
With ycmd, company, and flycheck I get really fast and really accurate completions
with my CPU idling most of the time, so I also get great battery life.
Finally, mission accomplished!</p>

<h3 id="youcompleteme-tips">YouCompleteMe Tips</h3>

<p>I use YCMD for a fairly complex C++14 project that uses many new language
features and has a lot of class and function templates. To get really good
code completion I’ve developed a python script for YCMD that very
aggressively finds compilation flags for header files. The reason such a
script is necessary at all is because a <code class="language-plaintext highlighter-rouge">compile_commands.json</code> file does
not contain any compilation flags for header files, since they aren’t
compiled. I’ve shared the script as a <a href="https://gist.github.com/nilsdeppe/449f1bd4920b7f50b6f05d8f7fda4f6f">Gist here</a>.
The script must be placed at <code class="language-plaintext highlighter-rouge">~/.ycm_extra_conf.py</code> for the Emacs
configuration to find and use it. If you do not want to use the
script, then remove the lines</p>

<figure class="highlight"><pre><code class="language-elisp" data-lang="elisp"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="nv">set-variable</span> <span class="ss">'ycmd-extra-conf-whitelist</span> <span class="o">'</span><span class="p">(</span><span class="s">"~/.ycm_extra_conf.py"</span><span class="p">))</span>

<span class="p">(</span><span class="nv">set-variable</span> <span class="ss">'ycmd-global-config</span> <span class="s">"~/.ycm_extra_conf.py"</span><span class="p">)</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>from the
Emacs init file.</p>

<p>Another thing to be aware of is that getting YCMD, or more specifically
libclang, to play nicely with precompiled headers took some work. See
<a href="https://github.com/Valloric/ycmd/issues/892">this issue</a> on the YCMD GitHub for details. The short
story is that if you use precompiled headers you might have to build
YCMD using your system libclang by passing <code class="language-plaintext highlighter-rouge">--system-libclang</code> to
the build script.</p>

<h3 id="lsp-mode-and-clangd-update-141019">LSP mode and clangd (UPDATE 14/10/19)</h3>

<p>I’ve recently switched from <a href="https://github.com/Valloric/ycmd">YCMD</a> to using <a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a> and
<a href="https://clang.llvm.org/extra/clangd/">clangd</a>. With the release of clang 9, <a href="https://clang.llvm.org/extra/clangd/">clangd</a> has received a
lot of critical features (in my eyes) and is now at a point where I can use it
in my day-to-day work. <a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a> uses the <a href="https://github.com/Microsoft/language-server-protocol/">Language Server Protocol
(LSP)</a>, which provides a language-agnostic standard for completion/syntax
checking engines like <a href="https://clang.llvm.org/extra/clangd/">clangd</a> or the <a href="https://github.com/palantir/python-language-server">python-language-server
(pyls)</a> to communicate with an IDE. The configuration for
<a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a> is quite simple and I don’t see the need to provide
customization points that I provided with YCMD. If I’m wrong please let me know
in the comments or file an issue on the <a href="https://github.com/nilsdeppe/MyEnvironment">GitHub
repo</a> where I keep my environment files. I still use company as
the completion frontend so the GIFs are mostly up-to-date, except that
<a href="https://clang.llvm.org/extra/clangd/">clangd</a> seems to be better at completion than <a href="https://github.com/Valloric/ycmd">YCMD</a> in my
experience.</p>

<h3 id="git-source-code-management">Git Source Code Management</h3>

<p>I also perform all my git operations inside Emacs using <a href="https://magit.vc/">magit</a>,
and use <a href="https://github.com/syohex/emacs-git-gutter">git-gutter</a> to show me which lines I’ve changed in
the current file. Magit is extremely feature rich and I highly recommend
reading through the <a href="https://magit.vc/manual/magit.html">lengthy documentation</a>. You will very
quickly save the time you invest by no longer typing out long git
commands. There are also screencasts available on the magit site, so I
won’t show any here.</p>

<h3 id="fast-startup-time">Fast Startup Time</h3>

<p><em>Note:</em> This section was added on Feb. 10, 2018. The functionality of the
configuration does not change, but it is faster to load.</p>

<p>I don’t do much python development and I especially try to avoid notebooks, but
sometimes I have no choice. I find web browsers to be a terrible
development environment and so I’ve started using <a href="https://github.com/millejoh/emacs-ipython-notebook">EIN</a> for editing
Jupyter notebooks. This makes the process much more tolerable. Unfortunately,
starting a Jupyter server when starting Emacs takes ~2.5s, which is a long
time. I use an Emacs server on my development machine, but when working on a
supercomputer I typically don’t, or still have to have it load when I log in. I
decided to do some research and use <a href="https://github.com/jwiegley/use-package"><code class="language-plaintext highlighter-rouge">use-package</code></a> to speed up the
load time. The result is that my Emacs startup time is down to ~0.6s from
~4.7s without loss of functionality. While I’d love to have it be 0.1s, 0.6s
makes the startup time very tolerable. I won’t say more about this other than
that I’ve shared my most recent version of my <code class="language-plaintext highlighter-rouge">~/.emacs.el</code> file in the
<a href="https://github.com/nilsdeppe/MyEnvironment"><del>Gist</del> GitHub repo here</a>.</p>

<h3 id="my-init-fileinstallation">My init File/Installation</h3>

<p>I’ve shared my init file as a <a href="https://github.com/nilsdeppe/MyEnvironment"><del>Gist</del> GitHub repo here</a>. The
only things
you will need to do to have it completely replace your current configuration
are install <a href="https://github.com/Valloric/ycmd">ycmd</a> and change the path to where you installed ycmd
(search for <code class="language-plaintext highlighter-rouge">/home/nils/Research/ycmd</code> in the <code class="language-plaintext highlighter-rouge">.emacs.el</code> file). To ensure
Emacs loads the new init file make sure that you do not have an
<code class="language-plaintext highlighter-rouge">~/.emacs</code> or <code class="language-plaintext highlighter-rouge">~/.emacs.d/init.el</code> file. Make sure you have an internet
connection when you start Emacs because it will download
and install any missing or outdated packages automatically for you. If
everything is correct you should not receive any errors or warnings in
the <code class="language-plaintext highlighter-rouge">*Messages*</code>, <code class="language-plaintext highlighter-rouge">*warnings*</code>, and <code class="language-plaintext highlighter-rouge">*ycmd-server*</code> buffer.</p>

<p>I’ll now provide a step-by-step guide to installing my configuration.</p>

<p>Prerequisites:</p>

<ul>
  <li>Emacs 24.5 or newer</li>
  <li><del><a href="https://github.com/Valloric/ycmd">YCMD</a> and its requirements (e.g. glibc version 2.14 or newer)</del></li>
  <li><a href="https://clang.llvm.org/extra/clangd/">clangd</a> for C/C++ completion (I recommend version 9 or newer)</li>
  <li><a href="https://github.com/palantir/python-language-server">pyls</a> for python code completion and syntax checking</li>
  <li><a href="https://github.com/palantir/python-language-server">bash-language-server</a> if you want bash syntax checking and code
completion</li>
  <li><a href="https://github.com/rust-lang/rls">Rust language server</a> if you want rust completion and syntax checking</li>
  <li><a href="https://github.com/BurntSushi/ripgrep">ripgrep</a> (optional, remove from init if you don’t have it)</li>
</ul>

<p>Installation:</p>

<ol>
  <li>Make a copy of your <code class="language-plaintext highlighter-rouge">~/.emacs</code> or <code class="language-plaintext highlighter-rouge">~/.emacs.el</code>, as well as <code class="language-plaintext highlighter-rouge">~/.emacs.d</code></li>
  <li>Delete <code class="language-plaintext highlighter-rouge">~/.emacs</code>, <code class="language-plaintext highlighter-rouge">~/.emacs.el</code>, or <code class="language-plaintext highlighter-rouge">~/.emacs.d/init.el</code>, whichever you use</li>
  <li>Copy the <a href="https://github.com/nilsdeppe/MyEnvironment"><del>Gist</del> GitHub repo .emacs.el</a> to <code class="language-plaintext highlighter-rouge">~/.emacs.el</code></li>
  <li>Start Emacs. If Emacs does not start installing packages immediately press
<code class="language-plaintext highlighter-rouge">M-x</code> and run <code class="language-plaintext highlighter-rouge">list-packages</code>, then close and start Emacs again.</li>
  <li>If any packages fail to install automatically, press <code class="language-plaintext highlighter-rouge">M-x</code> and run
<code class="language-plaintext highlighter-rouge">list-packages</code> to install them manually, though most will install
automatically.</li>
  <li>Edit <code class="language-plaintext highlighter-rouge">~/.emacs.el</code> replacing <code class="language-plaintext highlighter-rouge">/home/nils/Research/ycmd/ycmd</code> with the path
to wherever you’ve chosen to install ycmd and restart Emacs.</li>
  <li>Copy the <a href="https://gist.github.com/nilsdeppe/449f1bd4920b7f50b6f05d8f7fda4f6f">ycmd Gist</a> to <code class="language-plaintext highlighter-rouge">~/.ycm_extra_conf.py</code></li>
</ol>

<p>Note: On one machine I installed this configuration on I had to comment out
the <code class="language-plaintext highlighter-rouge">(require 'yasnippet)</code> section, start Emacs and let everything install,
then uncomment that section and restart Emacs.</p>

<h3 id="summary">Summary</h3>

<p>In this post I gave a fairly brief overview of the major changes I’ve
made to my Emacs configuration.
I’ve put in a fair amount of effort into cleaning up and organizing my
Emacs init file, so hopefully sharing it <a href="https://github.com/nilsdeppe/MyEnvironment">here</a>
is enough to get you started. If not, please leave a comment on
what you want an explanation on and I’ll update this post with more
information.</p>

</p>
          </div>
        </div><!-- .col-md-7 close -->
      </div>
    </div>
  </section>
</div>
<p class="center-text" style="padding: 30px;">
  <a href="/blog">Back to blog</a>
</p>


<div id="disqus_thread"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'nilsdeppe'; // required: replace example with your forum shortname
        // var disqus_developer = 1; // Comment out when the site is live
        var disqus_identifier = "/posts/emacs-c++-ide2";

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>












    <!-- footer Start -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="footer-manu">
          <ul>
            <li><a href="/">Home</a></li>
            <li><a href="/blog">Blog</a></li>
            <li><a href="/contact">Contact</a></li>
            
            <li><a href="/assets/pdfs/cv.pdf" target="_blank" title="CV"><i class="ai ai-cv ai-1x"></i></a></li>
            
            
            <li><a href="https://orcid.org/0000-0003-4557-4115" target="_blank" title="ORCID"><i class="ai ai-orcid ai-1x"></i></a></li>
            
            
            <li><a href="https://arxiv.org/search/?query=Deppe%2C+Nils&searchtype=author&abstracts=show&order=-announced_date_first&size=200" target="_blank" title="arXiv"><i class="ai ai-arxiv ai-1x"></i></a></li>
            
            
            <li><a href="https://github.com/nilsdeppe" target="_blank" title="GitHub"><i class="fab fa-github fa-1x"></i></a></li>
            
            
            <li><a href="https://www.linkedin.com/in/nilsdeppe" target="_blank" title="LinkedIn"><i class="fab fa-linkedin fa-1x"></i></a></li>
            
          </ul>
        </div>
        <p>Copyright &copy; Design &amp; Developed by <a href="http://www.themefisher.com">Themefisher</a>. All rights reserved.</p>
      </div>
    </div>
  </div>
</footer>


    </body>
</html>
